<!-- templates/automation.html -->
{% extends "base.html" %}
{% block title %}Automation Settings | Zyberfy{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">

  <!-- Header and Back Link -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold">Automation Settings</h2>
    <a href="{{ url_for('dashboard') }}" class="text-sm text-gray-500 hover:text-gray-700">&larr; Back to Dashboard</a>
  </div>

  <!-- Success Banner -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div id="success-banner" class="w-full bg-blue-100 border border-blue-300 text-blue-800 px-4 py-3 rounded mb-6 shadow text-center flex justify-center items-center gap-2 transition-opacity duration-700 ease-in-out">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
          </svg>
          <span>{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('automation') }}" class="space-y-6">
    <!-- Tone Input -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Describe your tone, personality, or voice</label>
      <textarea name="tone" rows="3" class="w-full p-3 border rounded-lg text-sm" placeholder="Ex: Friendly, luxury concierge, calm, elegant, or direct.">{{ tone }}</textarea>
      <p class="text-sm text-gray-500 mt-1">Ex: Friendly, luxury concierge, calm, warm and elegant, etc.</p>
    </div>

    <!-- Toggles -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <label class="inline-flex items-center">
        <input type="checkbox" name="full_auto" class="form-checkbox" {% if full_auto %}checked{% endif %}>
        <span class="ml-2">Enable Smart Follow-ups</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" name="accept_offers" class="form-checkbox" {% if accept_offers %}checked{% endif %}>
        <span class="ml-2">Auto Accept Offers</span>
      </label>
      <label class="inline-flex items-center">
        <input type="checkbox" name="reject_offers" class="form-checkbox" {% if reject_offers %}checked{% endif %}>
        <span class="ml-2">Auto Reject Low Offers</span>
      </label>
      <div>
        <label class="block text-sm font-medium text-gray-700">Proposal Length</label>
        <select name="length" class="w-full border-gray-300 rounded-lg shadow-sm">
          <option value="concise" {% if length == 'concise' %}selected{% endif %}>Concise</option>
          <option value="detailed" {% if length == 'detailed' %}selected{% endif %}>Detailed</option>
        </select>
      </div>
    </div>

    <!-- Branding Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
        <input type="text" name="first_name" value="{{ first_name }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
        <input type="text" name="company_name" value="{{ company_name }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
        <input type="text" name="position" value="{{ position }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
        <input type="text" name="website" value="{{ website }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
        <input type="text" name="phone" value="{{ phone }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Reply-To Email</label>
        <input type="text" name="reply_to" value="{{ reply_to }}" class="w-full border p-2 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
        <input type="text" name="timezone" value="{{ timezone }}" class="w-full border p-2 rounded" />
      </div>
    </div>

    <!-- Save Button -->
    <div>
      <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">Save Settings</button>
    </div>
  </form>

  <!-- Collapsible Preview -->
  <div class="mt-10">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">Test Output (Preview)</h3>
      <button id="toggle-preview" class="text-blue-600 text-sm hover:underline font-medium">
        Show Preview
      </button>
    </div>
    <div id="preview-box" class="bg-gray-100 rounded-lg text-sm text-gray-700 whitespace-pre-wrap p-4 transition-all duration-300 ease-in-out max-h-0 overflow-hidden">
      {{ preview or 'Click "Save Settings" to see a preview of how the AI will sound.' }}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  setTimeout(() => {
    const banner = document.getElementById("success-banner");
    if (banner) {
      banner.classList.add("opacity-0");
      setTimeout(() => banner.remove(), 700);
    }
  }, 3000);

  const toggleBtn = document.getElementById("toggle-preview");
  const previewBox = document.getElementById("preview-box");

  toggleBtn.addEventListener("click", () => {
    const expanded = previewBox.classList.contains("max-h-[1000px]");
    if (expanded) {
      previewBox.classList.remove("max-h-[1000px]", "py-4", "px-4");
      previewBox.classList.add("max-h-0", "overflow-hidden");
      toggleBtn.textContent = "Show Preview";
    } else {
      previewBox.classList.remove("max-h-0", "overflow-hidden");
      previewBox.classList.add("max-h-[1000px]", "py-4", "px-4");
      toggleBtn.textContent = "Hide Preview";
    }
  });
</script>
{% endblock %}