{% extends "base.html" %}
{% block title %}Dashboard | Zyberfy{% endblock %}

{% block content %}
  <h2 class="text-2xl font-bold mb-4">Welcome back, {{ first_name }}!</h2>
  <p class="mb-6">Plan: <strong>{{ plan_status|capitalize }}</strong></p>

  {% if plan_status == 'pro' %}
    <div class="space-x-4 mb-6">
      <a href="{{ url_for('automation') }}"
         class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Automation</a>
      <a href="{{ url_for('proposal') }}"
         class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">New Proposal</a>
    </div>

    <!-- Analytics Section -->
    <div class="mt-12">
      <h3 class="text-xl font-semibold mb-4">Analytics Overview (Last 7 Days)</h3>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h2 id="stat-pageviews" class="text-2xl font-bold">0</h2>
          <p class="text-sm text-gray-500">Pageviews</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h2 id="stat-generated" class="text-2xl font-bold">0</h2>
          <p class="text-sm text-gray-500">Proposals Generated</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h2 id="stat-sent" class="text-2xl font-bold">0</h2>
          <p class="text-sm text-gray-500">Proposals Sent</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
          <h2 id="stat-conversion" class="text-2xl font-bold">0%</h2>
          <p class="text-sm text-gray-500">Conversion Rate</p>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow mb-8">
        <canvas id="analyticsChart" height="100"></canvas>
      </div>

      <h4 class="text-lg font-semibold mb-2">Recent Activity</h4>
      <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="py-2 px-4">Event</th>
              <th class="py-2 px-4">Timestamp</th>
            </tr>
          </thead>
          <tbody id="analytics-tbody">
            <tr>
              <td colspan="2" class="py-4 text-center text-gray-400">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <a href="{{ url_for('memberships') }}"
       class="mt-6 inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
      Subscribe / Upgrade
    </a>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    const analyticsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Pageviews',
            data: [],
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            fill: false
          },
          {
            label: 'Generated Proposals',
            data: [],
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 2,
            fill: false
          },
          {
            label: 'Sent Proposals',
            data: [],
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });

    async function refreshAnalytics() {
      const res = await fetch('/analytics-data?range=7');
      const data = await res.json();

      document.getElementById('stat-pageviews').textContent = data.pageviews;
      document.getElementById('stat-generated').textContent = data.generated;
      document.getElementById('stat-sent').textContent = data.sent;
      document.getElementById('stat-conversion').textContent = data.conversion_rate + '%';

      analyticsChart.data.labels = data.labels;
      analyticsChart.data.datasets[0].data = data.pv_data;
      analyticsChart.data.datasets[1].data = data.gen_data;
      analyticsChart.data.datasets[2].data = data.sent_data;
      analyticsChart.update();

      const tbody = document.getElementById('analytics-tbody');
      tbody.innerHTML = "";

      if (data.recent_events.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" class="py-4 text-center text-gray-400">No recent events found.</td></tr>`;
      } else {
        data.recent_events.forEach(e => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="py-2 px-4">${e.event_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
            <td class="py-2 px-4">${e.timestamp}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    refreshAnalytics();
    setInterval(refreshAnalytics, 10000);
  </script>
{% endblock %}
