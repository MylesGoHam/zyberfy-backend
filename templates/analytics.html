<!-- templates/analytics.html -->
{% extends "base.html" %}
{% block title %}Analytics | Zyberfy{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
  <!-- Back Button and Filters -->
  <div class="flex items-center justify-between mb-6">
    <a href="{{ url_for('dashboard') }}" class="text-sm bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded shadow-sm">
      ‚Üê Back to Dashboard
    </a>
    <div class="flex items-center gap-3">
      <div>
        <label for="range" class="mr-2 text-sm font-medium text-gray-600">Range:</label>
        <select id="range" class="border rounded px-3 py-1 text-sm">
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
        </select>
      </div>
      <div>
        <label for="eventType" class="mr-2 text-sm font-medium text-gray-600">Event:</label>
        <select id="eventType" class="border rounded px-3 py-1 text-sm">
          <option value="">All</option>
          <option value="pageview">Pageview</option>
          <option value="proposal_generated">Proposal Generated</option>
          <option value="proposal_sent">Proposal Sent</option>
        </select>
      </div>
      <button onclick="downloadCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm shadow">
        Download CSV
      </button>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h2 id="stat-pageviews" class="text-2xl font-bold">0</h2>
      <p class="text-sm text-gray-500">Pageviews</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h2 id="stat-generated" class="text-2xl font-bold">0</h2>
      <p class="text-sm text-gray-500">Proposals Generated</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h2 id="stat-sent" class="text-2xl font-bold">0</h2>
      <p class="text-sm text-gray-500">Proposals Sent</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h2 id="stat-conversion" class="text-2xl font-bold">0%</h2>
      <p class="text-sm text-gray-500">Conversion Rate</p>
    </div>
  </div>

  <!-- Graph -->
  <div class="bg-white p-4 rounded-lg shadow mb-10">
    <canvas id="analyticsChart" height="100"></canvas>
  </div>

<!-- Recent Activity Table -->
<div class="flex items-center justify-between mb-3">
  <h3 class="text-lg font-semibold">Recent Activity</h3>
  <div class="flex gap-2 items-center">
    <select id="activityFilter" class="border px-2 py-1 rounded text-sm">
      <option value="">All</option>
      <option value="generated_proposal">Proposals Generated</option>
      <option value="sent_proposal">Proposals Sent</option>
    </select>
    <select id="activitySort" class="border px-2 py-1 rounded text-sm">
      <option value="desc">Newest First</option>
      <option value="asc">Oldest First</option>
    </select>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Pageviews', data: [], borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 2, fill: false },
      { label: 'Generated Proposals', data: [], borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 2, fill: false },
      { label: 'Sent Proposals', data: [], borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 2, fill: false }
    ]},
    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
  });

  async function refreshAnalytics() {
    const range = document.getElementById('range').value;
    const eventType = document.getElementById('eventType').value;
    const res = await fetch(`/analytics-data?range=${range}&event_type=${eventType}`);
    const data = await res.json();

    document.getElementById('stat-pageviews').textContent = data.pageviews;
    document.getElementById('stat-generated').textContent = data.generated;
    document.getElementById('stat-sent').textContent = data.sent;
    document.getElementById('stat-conversion').textContent = data.conversion_rate + '%';

    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.pv_data;
    chart.data.datasets[1].data = data.gen_data;
    chart.data.datasets[2].data = data.sent_data;
    chart.update();

    const tbody = document.getElementById('analytics-tbody');
    tbody.innerHTML = data.recent_events.length === 0
      ? `<tr><td colspan="2" class="py-4 text-center text-gray-400">No recent events found.</td></tr>`
      : data.recent_events.map(e => `
        <tr>
          <td class="py-2 px-4">${e.event_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
          <td class="py-2 px-4">${e.timestamp}</td>
        </tr>
      `).join('');
  }

  function downloadCSV() {
    const range = document.getElementById('range').value;
    const eventType = document.getElementById('eventType').value;
    window.location.href = `/export-analytics?range=${range}&event_type=${eventType}`;
  }

  document.getElementById("range").addEventListener("change", refreshAnalytics);
  document.getElementById("eventType").addEventListener("change", refreshAnalytics);
  refreshAnalytics();
  setInterval(refreshAnalytics, 10000);
</script>
{% endblock %}
