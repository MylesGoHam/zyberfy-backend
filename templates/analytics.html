{% extends "base.html" %}
{% block title %}Analytics – Zyberfy{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- your analytics chart code… -->
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Grab data injected by Jinja
    const kpis           = {{ kpis|tojson }};
    const donutConverted = {{ donut_converted|tojson }};
    const donutDropped   = {{ donut_dropped|tojson }};
    const lineLabels     = {{ line_labels|tojson }};
    const lineData       = {{ line_data|tojson }};

    // 2) Sanity‐check
    console.log("▶ analytics data", { kpis, lineLabels, lineData });

    // 3) Render KPI cards
    const grid = document.querySelector('.metrics-grid');
    for (const [label, value] of Object.entries(kpis)) {
      const card = document.createElement('div');
      card.className = 'metric';
      card.innerHTML = `
        <div class="value">${value}</div>
        <div class="label">${label}</div>
      `;
      grid.append(card);
    }

    // 4) Draw the donut chart
    new Chart(document.getElementById('donutChart'), {
      type: 'doughnut',
      data: {
        labels: ['Converted','Dropped'],
        datasets: [{
          data: [donutConverted, donutDropped],
          backgroundColor: ['#1e40af','#ddd'],
          borderWidth: 0
        }]
      },
      options: {
        cutout: '70%',
        plugins: { legend: { position: 'bottom' } },
        maintainAspectRatio: false
      }
    });

    // 5) Draw the line chart
    new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: {
        labels: lineLabels,
        datasets: [{
          data: lineData,
          fill: false,
          pointRadius: 3,
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        },
        plugins: { legend: { display: false } },
        maintainAspectRatio: false
      }
    });
  });
</script>
{% endblock %}