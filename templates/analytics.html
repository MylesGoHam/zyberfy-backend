{% extends "base.html" %}

{% block title %}Analytics – Zyberfy{% endblock %}
{% block body_class %}analytics-page{% endblock %}

{% block content %}
  <header class="analytics-header">
    <a href="{{ url_for('dashboard') }}" class="back">← Dashboard</a>
  </header>

  <div class="analytics-container">
    <div class="metrics-grid"></div>

    <div class="chart-card">
      <h2>Conversion Rate</h2>
      <canvas id="donutChart"></canvas>
    </div>

    <div class="chart-card">
      <h2>Proposals This Month</h2>
      <canvas id="lineChart"></canvas>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const kpis           = {{ kpis|tojson }};
  const donutConverted = {{ donut_converted|tojson }};
  const donutDropped   = {{ donut_dropped|tojson }};
  const lineLabels     = {{ line_labels|tojson }};
  const lineData       = {{ line_data|tojson }};

  // KPI cards
  const grid = document.querySelector('.metrics-grid');
  for (const [label, value] of Object.entries(kpis)) {
    const c = document.createElement('div');
    c.className = 'metric';
    c.innerHTML = `<div class="value">${value}</div><div class="label">${label}</div>`;
    grid.append(c);
  }

  // charts
  new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: {
      labels: ['Converted','Dropped'],
      datasets: [{ data: [donutConverted,donutDropped], backgroundColor:['#1e40af','#ddd'], borderWidth:0 }]
    },
    options: { cutout:'70%', plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false }
  });

  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: { labels: lineLabels, datasets:[{ data: lineData, fill:false, pointRadius:3, borderWidth:2, tension:0.3 }] },
    options: { scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}, plugins:{legend:{display:false}}, maintainAspectRatio:false }
  });
});
</script>
{% endblock %}