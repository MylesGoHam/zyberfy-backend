@app.route('/analytics')
def analytics():
    if 'email' not in session:
        return redirect(url_for('login'))

    conn = get_db_connection()
    # look up numeric user_id
    user = conn.execute(
        "SELECT id FROM users WHERE email = ?",
        (session['email'],)
    ).fetchone()
    if not user:
        conn.close()
        flash("User not found", "error")
        return redirect(url_for('dashboard'))

    user_id = user['id']

    # aggregate totals
    rows = conn.execute("""
        SELECT event_type, COUNT(*) AS cnt
          FROM analytics_events
         WHERE user_id = ?
      GROUP BY event_type
    """, (user_id,)).fetchall()

    kpis       = {r['event_type']: r['cnt'] for r in rows}
    pageviews  = kpis.get('pageview', 0)
    configs    = kpis.get('saved_automation', 0)
    generated  = kpis.get('generated_proposal', 0)
    conversions= kpis.get('sent_proposal', 0)

    # <-- FIXED: use `conversions`, not undefined `sent` -->
    conversion_rate = (conversions / generated * 100) if generated else 0

    # donut slices
    donut_converted = conversions
    donut_dropped   = max(0, generated - conversions)

    # 7-day line chart
    today  = datetime.utcnow().date()
    dates  = [today - timedelta(days=i) for i in reversed(range(7))]
    line_labels = [d.strftime('%b %-d') for d in dates]

    line_data = []
    for d in dates:
        cnt = conn.execute("""
            SELECT COUNT(*) AS cnt
              FROM analytics_events
             WHERE user_id = ?
               AND event_type = 'pageview'
               AND date(timestamp) = ?
        """, (user_id, d)).fetchone()['cnt']
        line_data.append(cnt)

    conn.close()

    return render_template('analytics.html',
        pageviews=pageviews,
        configs=configs,
        generated=generated,
        conversions=conversions,
        conversion_rate=round(conversion_rate, 1),
        donut_converted=donut_converted,
        donut_dropped=donut_dropped,
        line_labels=line_labels,
        line_data=line_data
    )
