{% extends "base.html" %}

{% block title %}Analytics – Zyberfy{% endblock %}

{% block content %}
  <header>
    <a href="{{ url_for('dashboard') }}" class="back">← Dashboard</a>
    <div class="hamburger" role="button" aria-label="Menu" tabindex="0">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <nav id="dropdown" class="dropdown">
      <a href="{{ url_for('dashboard') }}">Home</a>
      <a href="{{ url_for('analytics') }}">Analytics</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </header>

  <div class="container">
    <div class="metrics-grid"></div>

    <div class="chart-card">
      <h2>Conversion Rate</h2>
      <canvas id="donutChart"></canvas>
    </div>

    <div class="chart-card">
      <h2>Proposals This Month</h2>
      <canvas id="lineChart"></canvas>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // dropdown toggle
    const dd = document.getElementById('dropdown'),
          hb = document.querySelector('.hamburger');
    hb.addEventListener('click', () => {
      const open = getComputedStyle(dd).display !== 'none';
      dd.style.display = open ? 'none' : 'flex';
    });
    document.addEventListener('click', e => {
      if (!dd.contains(e.target) && !hb.contains(e.target)) {
        dd.style.display = 'none';
      }
    });

    // Data from Flask
    const donutConverted = {{ donut_converted|tojson }},
          donutDropped   = {{ donut_dropped|tojson }},
          lineLabels     = {{ line_labels|tojson }},
          lineData       = {{ line_data|tojson }},
          kpis           = {{ kpis|tojson }};

    // Populate KPI cards
    const metricsGrid = document.querySelector('.metrics-grid');
    Object.entries(kpis).forEach(([label, value]) => {
      const card = document.createElement('div');
      card.className = 'metric';
      card.innerHTML = `<div class="value">${value}</div><div class="label">${label}</div>`;
      metricsGrid.append(card);
    });

    // Render Donut chart
    new Chart(document.getElementById('donutChart'), {
      type: 'doughnut',
      data: {
        labels: ['Converted','Dropped'],
        datasets: [{ data: [donutConverted, donutDropped] }]
      },
      options: {
        cutout: '70%',
        plugins: { legend: { position: 'bottom' } },
        maintainAspectRatio: false
      }
    });

    // Render Line chart
    new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: {
        labels: lineLabels,
        datasets: [{
          data: lineData,
          fill: false,
          pointRadius: 3,
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        },
        plugins: { legend: { display: false } },
        maintainAspectRatio: false
      }
    });
  });
</script>
{% endblock %}